---
- hosts: localhost
  become: yes
  tasks:
    - name: "Generating locale for UK English"
      shell:
        cmd: locale-gen en_GB.UTF-8

    - name: "Setting Keyboard Keymap for UK English"
      shell:
        cmd: localectl set-keymap gb

    - name: "Installing C Compiler Packages and Dependencies"
      apt:
        name:
          - git
          - cmake
          - xorg-dev
          - gcc
          - g++
          - build-essential
        state: latest

    - name: "Clone GL4ES repository"
      git:
        repo: https://github.com/ptitSeb/gl4es.git
        dest: /root/gl4es
        single_branch: yes
        version: master

    - name: "Make GL4ES Build Directory"
      file:
        path: /root/gl4es/build
        state: directory

    - name: "Compile GL4ES with CMAKE"
      shell:
        cmd: cd /root/gl4es/build && cmake .. -DODROID=1

    - name: "Compile GL4ES with Make"
      shell:
        cmd: cd /root/gl4es/build && make -j

    - name: "Backup Current libGL"
      file:
        path: /usr/lib/aarch64-linux-gnu/libGL.so.1.7.0
        dest: /usr/lib/aarch64-linux-gnu/save.libGL.so.1.7.0
      
    - name: "Remove libGL.so Symlink"
      file:
        path: /usr/lib/aarch64-linux-gnu/libGL.so
        state: absent

    - name: "Remove libGL.so.1"
      file:
        path: /usr/lib/aarch64-linux-gnu/libGL.so.1
        state: absent

    - name: "Install new libGL.so.1"
      file:
        path: /root/gl4es/lib/libGL.so.1
        dest: /usr/lib/aarch64-linux-gnu/libGL.so.1

    - name: "Symlink new libGL.so.1 to libGL.so"
      file:
        path: /usr/lib/aarch64-linux-gnu/libGL.so.1
        dest: /usr/lib/aarch64-linux-gnu/libGL.so
        state: link

    - name: "Reload Configs"
      shell:
        cmd: ldconfig

    - name: "Install Kodi PPA"
      apt_repository:
        repo: ppa:team-xbmc/ppa

    - name: "Install Kodi and Dependencies"
      apt:
        name:
          - kodi-fbdev
          - kodi-fbdev-bin
          - kodi-fbdev-data
          - libcec4
          - ffmpeg
          - libavcodec-extra
          - libavcodec-extra58
          - libavdevice58
          - libavfilter-extra
          - libavformat58
          - libdlna0
          - libpostproc55
          - libswresample3
          - libswscale5 
    
    - name: "Adding Kodi User Account"
      user:
        name: kodi
        comment: kodi
        groups: kodi,cdrom,video,plugdev,users,dialout,dip,input,netdev,audio,pulse,pulse-access,games
        uid: 1000
        append: yes

    - name: "Installing Kodi SystemCTL Service config"
      file:
        path: /root/bootstrap-ubuntu/armv8/odroid/n2plus/kodi.service
        dest: /etc/systemd/system/kodi.service

    - name: "Reload SystemCTL configs"
      shell:
        cmd: systemctl daemon-reload

    - name: "Enable Kodi service on boot"
      shell:
        cmd: systemctl enable kodi
    
    - name: "Set SystemCTL default to multi-user.wants level"
      shell:
        cmd: systemctl set-default multi-user.target

    - name: "Enable Pulseaudio user"
      shell:
        cmd: systemctl --user enable pulseaudio.service

    - name: "Disable ModemManager"
      shell:
        cmd: systemctl disable ModemManager

    - name: "Installing Timezone Management App"
      apt:
        name:
          - chrony

    - name: "Setting Timezone to London"
      shell:
        cmd: timedatectl set-timezone Europe/London